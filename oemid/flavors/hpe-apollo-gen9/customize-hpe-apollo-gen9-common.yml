# Colonizer common customize ID file for HPE Apollo 4200 Gen9 deployment
#

    - shell: /bin/bash -c 'echo "Configuring system block devices..." > {{ fifo }}'

    - name: enumerate raid controller using hpssacli
      shell: hpssacli controller all show
      register: hpssacli_controller_show_cmd
      changed_when: false

    - set_fact:
        array_controller_slot: "{{ hpssacli_controller_show_cmd.stdout | regex_search('Smart Array .* in Slot ([0-9])', '\\1') | first }}"

    - name: looking for logical drives except OS RAID
      shell: hpssacli controller slot={{ array_controller_slot }} ld all show
      changed_when: false
      register: hpssacli_pd_show_cmd

    - set_fact:
        additional_logical_drives: "{{ hpssacli_pd_show_cmd.stdout | regex_findall('array ([B-Z])', '\\1') | sort(true) }}"

    - name: delete all logical drives except OS RAID
      shell: hpssacli controller slot={{ array_controller_slot }} array {{ item | upper }} delete forced
      changed_when: false
      with_items: "{{ additional_logical_drives }}"

    - name: wait for udev to settle
      shell: udevadm settle --timeout=60
      changed_when: false

    - name: create RAID configuration template
      template:
        src: "{{ raid_template }}"
        dest: /tmp/ssainput.ini

    - name: apply RAID configuration from template
      shell: hpssascripting -i /tmp/ssainput.ini
      changed_when: false

    - name: wait for udev to settle
      shell: udevadm settle --timeout=60
      changed_when: false

    - name: re-gather facts
      setup:

    - shell: /bin/bash -c 'echo "Verifying block devices..." > {{ fifo }}'

    - name: check if disk sizes and naming is as expected
      with_items: "{{ disks.keys() }}"
      assert:
        that:
          - ansible_devices[item]['host'] == disks[item]['host']
          - ansible_devices[item]['model'] == disks[item]['model']
          - ansible_devices[item]['vendor'] == disks[item]['vendor']
          - ansible_devices[item]['size'] == disks[item]['size']
        msg: "The system does not have the required disk layout."
